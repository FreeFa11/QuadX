<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Calibration</title><link rel="icon" type="image/x-icon" href="./favicon.ico"><style>body{display:flex;flex-direction:column;align-items:center;font-family:Arial,sans-serif;background-color:#131312;color:#e0e0e0;margin:0;padding:10px;min-height:100vh}h1{font-size:2rem;font-weight:700;text-transform:uppercase;color:#5aa6f3;letter-spacing:4px;text-shadow:2px 2px 5px rgba(0,0,0,.3);margin-bottom:20px;transition:all .3s}h1:hover{color:#943ce7;text-shadow:2px 2px 8px rgba(0,0,0,.5)}#refresh-button{position:absolute;top:40px;right:30px;padding:1px;font-size:10px;background-color:#3b3b5c;color:#fff;border:none;cursor:pointer;border-radius:5px}#refresh-button:hover{background-color:#6b6b9e}.slider-container{display:flex;align-items:center;gap:8px;margin:5px 15px;width:90%;background-color:#2c2c3e;padding:10px;border-radius:8px;border:2px solid #1e1e2f;box-shadow:0 2px 6px rgba(0,0,0,.3)}.slider-container label{width:120px;text-align:right;color:#d1d1d1;font-size:1em;font-weight:600}.slider{width:100%;max-width:250px;height:8px;background:#3b3b5c;outline:0;opacity:.9;border-radius:5px;border:2px solid #3b3b5c;box-shadow:0 2px 4px rgba(0,0,0,.3);-webkit-appearance:none;appearance:none}.slider:active,.slider:hover{opacity:1}.slider:active{transform:scale(1.03)}.slider::-webkit-slider-thumb{width:30px;height:16px;background:linear-gradient(135deg,#26a5fa,#fa03ee);border-radius:6px;box-shadow:0 3px 8px rgba(0,0,0,.3);cursor:pointer;-webkit-appearance:none}.section{width:85%;max-width:550px;margin-bottom:15px;background-color:#282838;padding:12px;border-radius:8px;border:2px solid #1e1e2f}.section-title{color:#5aa6f3;font-size:2rem;margin-bottom:12px;padding-bottom:5px;border-bottom:1px solid #3b3b5c;text-align:center}.value-display{width:55px;height:28px;background-color:#3b3b5c;border:1px solid #5aa6f3;border-radius:5px;color:#e0e0e0;font-size:.9rem;text-align:center;padding:4px;margin-left:8px}.value-display:focus{outline:0;border-color:#943ce7}.save-button{background:linear-gradient(135deg,#26a5fa,#fa03ee);color:#fff;border:none;padding:10px 20px;border-radius:5px;font-size:1rem;cursor:pointer;margin-top:15px;box-shadow:0 2px 5px rgba(0,0,0,.3);transition:transform .2s}.save-button:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.3)}.save-button:active{transform:translateY(0)}.burger{position:fixed;top:20px;left:20px;cursor:pointer;z-index:999999}.burger div{width:24px;height:2px;background-color:#e0e0e0;margin:5px 0;transition:.3s}.nav-menu{position:fixed;top:0;left:-220px;width:170px;height:100%;background-color:#1e1e1e;box-shadow:2px 0 5px rgba(0,0,0,.5);display:flex;flex-direction:column;padding-top:60px;transition:left .3s}.nav-menu.show{left:0}.nav-menu a{color:#e0e0e0;padding:12px 20px;text-decoration:none;display:flex;align-items:center;font-size:16px;border-bottom:1px solid #2c2c2c}.nav-menu a:hover{background-color:#2a2a2a}.nav-icon{width:30px;height:30px;margin-right:12px}.pid-container{margin-top:15px;padding:10px;background-color:#2c2c3e;border-radius:8px;border:1px solid #3b3b5c}.pid-controls{display:flex;justify-content:space-around;gap:10px}.pid-item{display:flex;flex-direction:column;align-items:center}.pid-item label{color:#d1d1d1;font-size:.9em;margin-bottom:5px}.pid-value-display{width:50px;height:28px;background-color:#3b3b5c;border:1px solid #5aa6f3;border-radius:5px;color:#e0e0e0;font-size:.9rem;text-align:center;padding:4px}.pid-value-display::-webkit-inner-spin-button,.pid-value-display::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.pid-value-display:focus{outline:0;border-color:#943ce7}.pid-input-group{display:flex;align-items:center;gap:3px}.pid-buttons{display:flex;flex-direction:column;gap:2px}.pid-btn{width:24px;height:17px;background:#3b3b5c;border:1px solid #5aa6f3;color:#e0e0e0;cursor:pointer;border-radius:2px;font-size:.65rem;padding:0;line-height:1;user-select:none;-webkit-user-select:none}.pid-btn:hover{background:#4b4b6c}.pid-btn:active{background:#2b2b4c}.sensitivity-container{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}.sensitivity-slider{display:flex;flex-direction:column;align-items:center;width:60px}.sensitivity-slider label{color:#d1d1d1;font-size:.9em;margin-bottom:5px}.sensitivity-value{color:#e0e0e0;font-size:.8rem;margin-top:5px}@media screen and (max-width:480px){.slider{max-width:150px}.value-display{width:45px;font-size:.8rem}.section{width:90%}.pid-controls{flex-direction:column;gap:5px}}</style></head><body><h1>Calibration</h1><button id="refresh-button" onclick="location.reload()">&#x21bb;</button><div class="section"><div class="section-title">Motor</div><div class="slider-container"><label for="motorA">Motor A:</label> <input type="range" id="motorA" min="0" max="100" value="0" class="slider"> <input type="number" id="motorAValue" class="value-display" min="0" max="100" value="0"></div><div class="slider-container"><label for="motorB">Motor 2:</label> <input type="range" id="motorB" min="0" max="100" value="0" class="slider"> <input type="number" id="motorBValue" class="value-display" min="0" max="100" value="0"></div><div class="slider-container"><label for="motorC">Motor 3:</label> <input type="range" id="motorC" min="0" max="100" value="0" class="slider"> <input type="number" id="motorCValue" class="value-display" min="0" max="100" value="0"></div><div class="slider-container"><label for="motorD">Motor 4:</label> <input type="range" id="motorD" min="0" max="100" value="0" class="slider"> <input type="number" id="motorDValue" class="value-display" min="0" max="100" value="0"></div><div class="slider-container"><label for="maxthrottle">MaxThrottle:</label> <input type="range" id="maxthrottle" min="0" max="800" value="0" class="slider"> <input type="number" id="maxthrottleValue" class="value-display" min="0" max="650" value="0"></div><div class="pid-container"><div class="section-title">PID</div><div class="pid-controls"><div class="pid-item"><label>P</label><div class="pid-input-group"><div class="pid-buttons"><button class="pid-btn" type="button">▲</button> <button class="pid-btn" type="button">▼</button></div><input type="number" id="PValue" class="pid-value-display" step="0.01"><div class="pid-buttons"><button class="pid-btn" type="button">▲</button> <button class="pid-btn" type="button">▼</button></div></div></div><div class="pid-item"><label>I</label><div class="pid-input-group"><div class="pid-buttons"><button class="pid-btn" type="button">▲</button> <button class="pid-btn" type="button">▼</button></div><input type="number" id="IValue" class="pid-value-display" step="0.01"><div class="pid-buttons"><button class="pid-btn" type="button">▲</button> <button class="pid-btn" type="button">▼</button></div></div></div><div class="pid-item"><label>D</label><div class="pid-input-group"><div class="pid-buttons"><button class="pid-btn" type="button">▲</button> <button class="pid-btn" type="button">▼</button></div><input type="number" id="DValue" class="pid-value-display" step="0.01"><div class="pid-buttons"><button class="pid-btn" type="button">▲</button> <button class="pid-btn" type="button">▼</button></div></div></div></div></div></div><div class="section"><div class="section-title">Sensitivity</div><div class="sensitivity-container"><div class="sensitivity-slider"><label>S1</label><input type="range" id="sensitivityS1" min="0" max="100" value="0" class="slider"><span id="sensitivityS1Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>S2</label><input type="range" id="sensitivityS2" min="0" max="100" value="0" class="slider"><span id="sensitivityS2Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>S3</label><input type="range" id="sensitivityS3" min="0" max="100" value="0" class="slider"><span id="sensitivityS3Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>S4</label><input type="range" id="sensitivityS4" min="0" max="100" value="0" class="slider"><span id="sensitivityS4Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>X1</label><input type="range" id="sensitivityX1" min="0" max="100" value="0" class="slider"><span id="sensitivityX1Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>X2</label><input type="range" id="sensitivityX2" min="0" max="100" value="0" class="slider"><span id="sensitivityX2Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>Y1</label><input type="range" id="sensitivityY1" min="0" max="100" value="0" class="slider"><span id="sensitivityY1Value" class="sensitivity-value">0%</span></div><div class="sensitivity-slider"><label>Y2</label><input type="range" id="sensitivityY2" min="0" max="100" value="0" class="slider"><span id="sensitivityY2Value" class="sensitivity-value">0%</span></div></div></div><button id="saveButton" class="save-button">Save Settings</button><div class="burger" onclick="toggleMenu()"><div></div><div></div><div></div></div><nav class="nav-menu" id="menu"><a href="./Controller.html"><img src="./controller-icon.svg" alt="Controller" class="nav-icon">Controller</a> <a href="./Calibration.html"><img src="./calibration-icon.svg" alt="Calibration" class="nav-icon">Calibration</a> <a href="./Connection.html"><img src="./connection-icon.svg" alt="Connection" class="nav-icon">Connection</a></nav><script>const DEF = { motorA: 0, motorB: 0, motorC: 0, motorD: 0, maxthrottle: 0, P: 0, I: 0, D: 0, sensitivityS1: 0, sensitivityS2: 0, sensitivityS3: 0, sensitivityS4: 0, sensitivityX1: 0, sensitivityX2: 0, sensitivityY1: 0, sensitivityY2: 0 };
        let ws, last = {};

        const throttle = (fn, d) => { let t = 0; return (...a) => { const n = Date.now(); if (n - t >= d) { t = n; return fn(...a) } } };

        const send = throttle(() => {
            if (ws?.readyState === WebSocket.OPEN) {
                const c = getVals();
                if (JSON.stringify(c) !== JSON.stringify(last)) {
                    ws.send(JSON.stringify({ type: 'output', ...c }));
                    last = { ...c };
                }
            }
        }, 50);

        function connectWS() {
            ws = new WebSocket(`ws://${window.location.hostname}/CommunicationSocket`);
            ws.onopen = () => { console.log('WS connected'); ws.send(JSON.stringify({ type: 'Calibration' })); };
            ws.onmessage = e => {
                try { const m = JSON.parse(e.data); m.type === 'calibration' && init(m.data); }
                catch (err) { console.error('Parse error:', err); }
            };
            ws.onerror = e => console.error('WS error:', e);
            ws.onclose = () => { console.log('WS closed'); setTimeout(connectWS, 1000); };
        }
        function setupSlider(id, did) {
            const s = document.getElementById(id), d = document.getElementById(did);
            s.oninput = () => {
                d.value = s.value;
                if (id.startsWith('motor')) updateMaxThrottle();
                send();
            };
            d.oninput = () => {
                let v = parseInt(d.value);
                if (isNaN(v)) v = s.min;
                v = Math.max(v, parseInt(s.min));
                v = Math.min(v, parseInt(s.max));
                s.value = d.value = v;
                if (id.startsWith('motor')) updateMaxThrottle();
                send();
            };
        }
        function updateMaxThrottle() {
            const m1 = parseInt(document.getElementById('motorA').value);
            const m2 = parseInt(document.getElementById('motorB').value);
            const m3 = parseInt(document.getElementById('motorC').value);
            const m4 = parseInt(document.getElementById('motorD').value);
            const maxMotor = Math.max(m1, m2, m3, m4);

            const maxThrottleSlider = document.getElementById('maxthrottle');
            const maxThrottleDisplay = document.getElementById('maxthrottleValue');

            maxThrottleSlider.min = maxMotor;
            maxThrottleDisplay.min = maxMotor;

            // Always update to at least maxMotor
            if (parseInt(maxThrottleSlider.value) < maxMotor) {
                maxThrottleSlider.value = maxMotor;
                maxThrottleDisplay.value = maxMotor;
            } else {
                // Force display refresh even if value is already higher
                maxThrottleDisplay.value = maxThrottleSlider.value;
            }
            send();
        }
        function setupSens(id, vid) {
            const s = document.getElementById(id), d = document.getElementById(vid);
            s.oninput = () => { d.textContent = `${s.value}%`; send(); };
        }

        function init(v) {
            ['motorA', 'motorB', 'motorC', 'motorD', 'maxthrottle'].forEach(id => {
                document.getElementById(id).value = v[id];
                document.getElementById(id + 'Value').value = v[id];
            });
            updateMaxThrottle();
            ['P', 'I', 'D'].forEach(id => document.getElementById(id + 'Value').value = v[id]);
            ['S1', 'S2', 'S3', 'S4', 'X1', 'X2', 'Y1', 'Y2'].forEach(a => {
                const id = 'sensitivity' + a;
                document.getElementById(id).value = v[id];
                document.getElementById(id + 'Value').textContent = v[id];
            });
            last = { ...v };
        }

        function getVals() {
            return {
                motorA: parseInt(document.getElementById('motorA').value),
                motorB: parseInt(document.getElementById('motorB').value),
                motorC: parseInt(document.getElementById('motorC').value),
                motorD: parseInt(document.getElementById('motorD').value),
                maxthrottle: parseInt(document.getElementById('maxthrottle').value),
                P: parseFloat(document.getElementById('PValue').value) || 0.0,
                I: parseFloat(document.getElementById('IValue').value) || 0.0,
                D: parseFloat(document.getElementById('DValue').value) || 0.0,
                sensitivityS1: parseInt(document.getElementById('sensitivityS1').value),
                sensitivityS2: parseInt(document.getElementById('sensitivityS2').value),
                sensitivityS3: parseInt(document.getElementById('sensitivityS3').value),
                sensitivityS4: parseInt(document.getElementById('sensitivityS4').value),
                sensitivityX1: parseInt(document.getElementById('sensitivityX1').value),
                sensitivityX2: parseInt(document.getElementById('sensitivityX2').value),
                sensitivityY1: parseInt(document.getElementById('sensitivityY1').value),
                sensitivityY2: parseInt(document.getElementById('sensitivityY2').value)
            };
        }

        async function save() {
            const c = getVals(), b = document.getElementById('saveButton');
            if (Object.values(c).some(v => v === null || v === undefined)) {
                console.error('Invalid values');
                b.textContent = 'Error: Invalid Values';
                setTimeout(() => { b.textContent = 'Save Settings'; b.disabled = false; }, 2000);
                return;
            }
            if (ws?.readyState === WebSocket.OPEN) {
                try {
                    b.disabled = true;
                    b.textContent = 'Saving...';
                    ws.send(JSON.stringify({ type: 'save', ...c }));
                    b.textContent = 'Saved!';
                    setTimeout(() => { b.textContent = 'Save Settings'; b.disabled = false; }, 2000);
                } catch (err) {
                    console.error('Save error:', err);
                    b.textContent = 'Error!';
                    setTimeout(() => { b.textContent = 'Save Settings'; b.disabled = false; }, 2000);
                }
            } else {
                console.error('WS not connected');
                b.textContent = 'Error: No Connection';
                setTimeout(() => { b.textContent = 'Save Settings'; b.disabled = false; }, 2000);
            }
        }

        async function load() {
            try {
                const r = await fetch('/api/getCalibration');
                if (!r.ok) throw new Error('Server error');
                init(await r.json());
            } catch (err) {
                console.error('Load error:', err);
                init(DEF);
            }
        }

        function adjustPID(inp, d) {
            const i = document.getElementById(inp);
            const cv = parseFloat(i.value) || 0.0;
            const nv = Math.round((cv + d) * 100) / 100;
            i.value = nv.toFixed(2);
            send();
        }

        function setupPID() {
            const pidItems = document.querySelectorAll('.pid-item');
            pidItems.forEach((item, idx) => {
                const inp = item.querySelector('.pid-value-display').id;
                const btns = item.querySelectorAll('.pid-btn');
                btns[0].onclick = () => adjustPID(inp, 0.1);
                btns[1].onclick = () => adjustPID(inp, -0.1);
                btns[2].onclick = () => adjustPID(inp, 0.01);
                btns[3].onclick = () => adjustPID(inp, -0.01);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            ['motorA', 'motorB', 'motorC', 'motorD', 'maxthrottle'].forEach(id => setupSlider(id, id + 'Value'));
            document.getElementById('saveButton').onclick = save;
            document.querySelectorAll('.pid-value-display').forEach(i => i.oninput = send);
            ['S1', 'S2', 'S3', 'S4', 'X1', 'X2', 'Y1', 'Y2'].forEach(a => setupSens('sensitivity' + a, 'sensitivity' + a + 'Value'));
            setupPID();
            load();
            connectWS();
        });

        function toggleMenu() {
            document.getElementById('menu').classList.toggle('show');
        }</script></body></html>